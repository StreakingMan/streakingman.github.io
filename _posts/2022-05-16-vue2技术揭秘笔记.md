---
layout: post
title: vue2æŠ€æœ¯æ­ç§˜ç¬”è®°
author: Max
categories: å¤§å‰ç«¯
tags: å‰ç«¯æ¡†æ¶ vue2
---

æœ¬æ–‡æ˜¯[vue æŠ€æœ¯æ­ç§˜](https://ustbhuangyi.github.io/vue-analysis/v2/prepare/)çš„ç¬”è®°
ï¼ˆä»¥ä¸‹ç»Ÿä¸€ã€Šæ­ç§˜ã€‹æŒ‡ä»£ï¼‰ï¼Œ é™¤éç‰¹ä½¿ï¼Œvue éƒ½æ˜¯æŒ‡çš„ 2.x ç‰ˆæœ¬ã€‚
è·Ÿç€å¤§ä½¬çš„è„šæ­¥è¿‡äº†ä¸€è¾¹ vue2 åº•å±‚ï¼Œåˆ†æå¾—å¾ˆè¯¦ç»†ï¼Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šæœç„¶èƒ½å¤Ÿçœ‹çš„æ›´é«˜ï¼Œæœ‰æ—¶é—´ç²¾åŠ›èƒ½åŠ›çš„æ—¶å€™å¿…å®šè‡ªå·±è¯»ä¸€ç•ªæºç ã€‚

æ­ç§˜ä¸»è¦åˆ†ä¸ºäº†æ•°æ®é©±åŠ¨ã€ç»„ä»¶åŒ–ã€å“åº”å¼åŸç†ã€ç¼–è¯‘æ‹“å±•è¿™å‡ ä¸ªéƒ¨åˆ†ï¼Œä¹Ÿåˆ†æäº† vue ç”Ÿæ€ vue router å’Œ vuexã€‚

## å‰ç½®å‡†å¤‡

ã€Šæ­ç§˜ã€‹æœ€å¼€å¤´ï¼Œä»‹ç»äº† vue çš„æ•´ä½“æƒ…å†µï¼Œvue2 æ˜¯ä½¿ç”¨ FlowJS åšçš„é™æ€ç±»å‹æ£€æŸ¥ï¼Œæ²¡æœ‰ä½¿ç”¨è¿‡è¿™ä¸ªåº“ï¼Œä½†çœ‹ä»‹ç»è·Ÿ TS æŒºåƒçš„ã€‚
vue çš„æºç åˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†

```
src
â”œâ”€â”€ compiler        # ç¼–è¯‘ç›¸å…³
â”œâ”€â”€ core            # æ ¸å¿ƒä»£ç 
â”œâ”€â”€ platforms       # ä¸åŒå¹³å°çš„æ”¯æŒ(webå’Œweex)
â”œâ”€â”€ server          # æœåŠ¡ç«¯æ¸²æŸ“
â”œâ”€â”€ sfc             # .vue æ–‡ä»¶è§£æ
â”œâ”€â”€ shared          # å…±äº«ä»£ç (æŒ‡æµè§ˆå™¨ç«¯å’ŒæœåŠ¡ç«¯çš„é€šç”¨ä»£ç )
```

> [Weex](https://doc.weex.io/zh/)ç®€å•è¯´å°±æ˜¯ä¸€ä¸ªç”¨ web æŠ€æœ¯å¼€å‘åŸç”Ÿåº”ç”¨çš„æ¡†æ¶

vue æºç æ˜¯åŸºäº Rollup æ„å»ºçš„ï¼Œä»æ„å»ºè„šæœ¬å¯ä»¥çœ‹å‡ºäº§ç‰©æœ‰ 3 ç§

```json
{
  "script": {
    "build": "node scripts/build.js",
    "build:ssr": "npm run build -- web-runtime-cjs,web-server-renderer",
    "build:weex": "npm run build -- weex"
  }
}
```

> å…³äº node ç¯å¢ƒä¸‹çš„`process.argv`å‚æ•°ï¼Œæ•°ç»„å‰ä¸¤ä¸ªä¸º node å’Œæ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ï¼Œç¬¬ä¸‰ä¸ªå¼€å§‹ä¾æ¬¡ä¸ºå‘½ä»¤ä¸­ç©ºæ ¼ç›¸é—´çš„å­—ç¬¦
> æ‰€ä»¥`web-runtime-cjs,web-server-renderer`å’Œ`weex`è¿™äº›å‚æ•°æ˜¯é€šè¿‡`process.argv[2]`è·å–çš„

`scripts/build.js`çš„æ„å»ºè¿‡ç¨‹ç®€å•æ¥è¯´å°±æ˜¯ï¼šåˆ¤æ–­å‘½ä»¤å‚æ•°->è¿‡æ»¤ç›¸åº”çš„é¢„è®¾æ„å»ºé…ç½®->æ„å»ºä¸åŒç”¨é€”çš„ vue.jsï¼Œ
è¯¦ç»†çš„æ„å»ºè¿‡ç¨‹è¿™é‡Œä¸å†ç»§ç»­å±•å¼€ï¼Œæ„å»ºé…ç½®ç®€å•æ¥è¯´å°±æ˜¯ä»¥ä¸‹å†…å®¹çš„ç»„åˆï¼š

- æ¨¡å—ç³»ç»Ÿï¼Œcjs è¿˜æ˜¯ esm
- ç¯å¢ƒï¼Œå¦‚å¼€å‘æ¨¡å¼çš„åŒ…ä¼šåŒ…å«å„ç§æ—¥å¿—æ‰“å°ï¼Œç”Ÿæˆæ¨¡å¼åˆ™ shake æ‰äº†ç›¸å…³ä»£ç 
- è¿è¡Œæ—¶å’Œç¼–è¯‘å™¨
- web è¿˜æ˜¯ weex
- æµè§ˆå™¨å’ŒæœåŠ¡ç«¯
- webpack æ’ä»¶

vue åŒæ—¶è¿˜æœ‰è¿è¡Œæ—¶ã€è¿è¡Œæ—¶+ç¼–è¯‘å™¨çš„ç‰ˆæœ¬ï¼Œè¿™ä¸¤è€…çš„åŒºåˆ«ç®€å•ç†è§£å°±æ˜¯`render`å‡½æ•°æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ã€‚

> vue çš„æœ€ç»ˆæ¸²æŸ“éƒ½æ˜¯`render`å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›çš„æ˜¯è™šæ‹Ÿ domï¼Œç¼–è¯‘æŒ‡çš„æ˜¯`template`è½¬æ¢æˆ`render`å‡½æ•°çš„è¿‡ç¨‹

å¦‚æœæ˜¯åœ¨ä»£ç è¿è¡Œçš„æ—¶å€™å»åšç¼–è¯‘è¿™ä¸€è¿‡ç¨‹ï¼Œé‚£ä¹ˆéœ€è¦ç”¨çš„æ˜¯è¿è¡Œæ—¶+ç¼–è¯‘å™¨çš„ç‰ˆæœ¬ï¼Œ
å¦‚æœåœ¨ä»£ç è¿è¡Œå‰å°±åšå¥½äº†ç¼–è¯‘å·¥ä½œï¼Œåˆ™åªéœ€è¦çº¯è¿è¡Œæ—¶ç‰ˆæœ¬ï¼ˆ`vue-loader`å°±æ˜¯ç”¨æ¥ä½“æ£€åšç¼–è¯‘å·¥ä½œçš„ï¼‰

è§‚å¯Ÿè¿è¡Œæ—¶+ç¼–è¯‘å™¨çš„äº§ç‰©`src/platforms/web/entry-runtime-with-compiler.js`ï¼Œä½œä¸ºå…¥å£æ–‡ä»¶ï¼Œåšçš„äº‹æƒ…ååˆ†ç®€æ´æ˜äº†ï¼š

1. ä»`./runtime/index`å¼•å…¥ Vueï¼Œè¿˜æœ‰ç¼–è¯‘å™¨ï¼Œä»¥åŠå…¶ä»–çš„ä¾èµ–
2. é‡å†™è¿è¡Œæ—¶ Vue åŸå‹ä¸Šçš„$mount æ–¹æ³•ï¼Œä¸»è¦æ˜¯åšäº†äº›å‰ç½®å·¥ä½œï¼š
   1. æ£€æŸ¥æŒ‚è½½çš„æ ¹å…ƒç´ ï¼Œä¸èƒ½æ˜¯`html`æˆ–è€…`body`
   2. æ£€æŸ¥æ¸²æŸ“å‡½æ•°ï¼Œæ²¡æœ‰æ¸²æŸ“å‡½æ•°æ—¶æ£€æŸ¥`template`å¹¶è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ï¼Œæ²¡æœ‰`template`åˆ™å–æŒ‚è½½å…ƒç´ çš„`outerHTML`ä½œä¸º`template`
   3. ç»§ç»­è°ƒç”¨åŸæœ¬çš„$mount
3. å°†ç¼–è¯‘å™¨æŒ‚è½½åˆ°æ‹“å±•åçš„ Vue çš„`compile`å±æ€§
4. å¯¼å‡ºæ‹“å±•çš„ Vue

æ¥ä¸‹æ¥ç»§ç»­çœ‹ vue è¿è¡Œæ—¶`src/platforms/web/runtime/index.js`ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å·¥ä½œï¼š

1. ä»`core/index`å¼•å…¥ Vue
2. æ‹“å±• Vue åŸå‹ï¼Œè®¾ç½®`__patch__`å’Œ`$mount`å±æ€§ï¼Œè¿˜æœ‰æ‚ä¸ƒæ‚å…«çš„

å†è¿›åˆ°`src/core/index.js`:

4. ä»`./instance/index`å¼•å…¥`Vue`å¯¹è±¡ï¼Œå¼•å…¥`initGlobalAPI`å’Œå…¶ä»–å·¥å…·
5. è°ƒç”¨`initGlobalAPI`åˆå§‹åŒ–å…¨å±€ Vue API
6. æ‹“å±•`Vue.prototype`ï¼Œå®šä¹‰äº†`$isServer`å’Œ`$ssrContext`
7. æ‹“å±•`Vue`ï¼Œå®šä¹‰äº†`FunctionalRenderContext`
8. æ ‡è®°ç‰ˆæœ¬å¹¶å¯¼å‡º`Vue`

è¿›åˆ°`src/core/instance/index.js`ï¼Œå¯ä»¥çœ‹åˆ°`Vue`æ˜¯ä¸€ä¸ªå‡½æ•°ç±»ï¼Œéœ€è¦ç”¨`new`æ¥å®ä¾‹åŒ–
ï¼ˆå¹¶ä¸”å†…éƒ¨åšäº†åˆ¤æ–­ï¼Œ`Vue`åªèƒ½ä½œä¸ºæ„é€ æ–¹æ³•ä½¿ç”¨ï¼‰ï¼Œåœ¨è¿™ä¸ªç±»å¯¼å‡ºä¹‹å‰ï¼Œæœ‰ä¸€ç³»åˆ—çš„`xxxMixin`æ–¹æ³•å¯¹è¿™ä¸ªç±»çš„åŸå‹è¿›è¡Œä¸€ç³»åˆ—çš„æ‹“å±•ï¼Œ
è¿™ä¹Ÿæ˜¯`Vue`æ²¡æœ‰ä½¿ç”¨ ES6 çš„ Class å®ç°é¢åŸå› ï¼šæ–¹ä¾¿ç»´æŠ¤å’Œç®¡ç†ã€‚

```javascript
function Vue(options) {
  if (process.env.NODE_ENV !== "production" && !(this instanceof Vue)) {
    warn("Vue is a constructor and should be called with the `new` keyword");
  }
  this._init(options);
}

initMixin(Vue);
stateMixin(Vue);
eventsMixin(Vue);
lifecycleMixin(Vue);
renderMixin(Vue);
```

è¯´å›`initGlobalAPI`ï¼Œå®ƒä½œç”¨æ˜¯`Vue.prototype`è¿›è¡Œäº†ä¸€ç³»åˆ—çš„æ–¹æ³•æ‹“å±•åï¼Œå¯¹`Vue`å¯¹è±¡æœ¬èº«æ‹“å±•å…¨å±€é™æ€æ–¹æ³•ï¼Œ
å…ˆæŒ‚è½½äº†ä»¥ä¸‹å±æ€§åˆ°`Vue`ä¸Šï¼š

- util
- set
- delete
- nextTick
- options

ç„¶åæ˜¯ä¸‹åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼š

```javascript
initUse(Vue);
initMixin(Vue);
initExtend(Vue);
initAssetRegisters(Vue);
```

> è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹æµç¨‹ä¸­å¯¹åŸå‹çš„æ‹“å±•å’Œå¯¹åŸå¯¹è±¡çš„é™æ€æ‹“å±•ï¼Œåœ¨åŸå‹ä¸Šæ‹“å±•çš„å†…å®¹ï¼Œæ˜¯ vue å®ä¾‹æ‰èƒ½è®¿é—®åˆ°çš„ï¼Œ
> è€Œåœ¨`Vue`ä¸Šæ‹“å±•çš„é™æ€å…¨å±€ APIï¼Œåˆ™éœ€è¦é€šè¿‡`Vue`å¯¹ä¸‹å²—æ¥è®¿é—®

å¤§è‡´è¿‡å®Œäº†æ¡†æ¶çš„å¤§æµç¨‹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒçš„åˆ†æäº†

## æ•°æ®é©±åŠ¨

æ•°æ®é©±åŠ¨ä½œä¸º vue çš„æ ¸å¿ƒå·²ç»è€å…«è‚¡æ–‡äº†ï¼Œé¢è¯•ç»å¸¸ä¼šé—®ï¼Œè€Œæˆ‘ä¹Ÿæ˜¯ç»å¸¸é‚£å‡ å¥è¯ï¼š

- æ•°æ®åŠ«æŒï¼Œ`defineProperty`
- ä¾èµ–æ”¶é›†ï¼Œå‘å¸ƒè®¢é˜…
- å•Šå§å•Šå§...

### å®ä¾‹åŒ–

å“ˆå“ˆï¼Œå…‰çŸ¥é“è¿™äº›è‚¯å®šä¸å¤Ÿçš„ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œã€Šæ­ç§˜ã€‹é¦–å…ˆå¸¦æˆ‘ä»¬ç»§ç»­æ·±æ‰’ vue çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œ
å›åˆ°`Vue`æ„é€ å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨åˆ¤æ–­å®Œæ˜¯å¦ä½œä¸ºæ„é€ æ–¹æ³•è°ƒç”¨åï¼Œç´§æ¥ç€è°ƒç”¨äº†`this._init`ï¼Œ
è€Œè¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•æ­£æ˜¯`initMixin`åœ¨`Vue.prototype`ä¸Šæ‹“å±•çš„ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å·¥ä½œï¼š

- åˆå¹¶é…ç½®é¡¹
- åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼ˆç»™ vm å®ä¾‹åŠ ä¸Šå„ç§ç”Ÿå‘½å‘¨æœŸçš„æ ‡è®°ï¼‰
- åˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒï¼ˆæ ¹æ® parent æ›´æ–°è‡ªå·±çš„ listenerï¼‰
- åˆå§‹åŒ–æ¸²æŸ“
- åˆå§‹åŒ– dataã€propsã€computedã€watcher ç­‰

ä»£ç ä¸­å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°`beaforeCreate`å’Œ`created`çš„ä¸¤é’©å­å‰åå‘ç”Ÿäº†ä»€ä¹ˆï¼š

```javascript
//...
initLifecycle(vm);
initEvents(vm);
initRender(vm); // å£°æ˜äº†vm.$createElementç­‰
callHook(vm, "beforeCreate");
initInjections(vm); // resolve injections before data/props
initState(vm);
initProvide(vm); // resolve provide after data/props
callHook(vm, "created");
//...
```

### æŒ‚è½½

ç›¸å…³çš„ç»†èŠ‚å¹¶æ²¡æœ‰ç»§ç»­æ·±å…¥ï¼Œæ¥ä¸‹æ¥æ˜¯`vm`çš„æŒ‚è½½è¿‡ç¨‹ï¼Œä¸Šæ–‡ä¹Ÿæåˆ°è¿è¡Œæ—¶ç‰ˆæœ¬çš„å…¥å£`platform/web/runtime/index.js`ï¼Œ
å¯¹`Vue.prototype`ä¸Šçš„`$mount`è¿›è¡Œäº†æ‹“å±•ï¼Œ`$mount`å†…éƒ¨åˆ™æ˜¯åœ¨æŸ¥è¯¢åˆ°å…ƒç´ åï¼Œæœ€ç»ˆè°ƒç”¨äº†`lifecycle`çš„`mountComponent`æ–¹æ³•ï¼Œ
å¹¶åŒæ—¶ä¼ å…¥`vm`å®ä¾‹ï¼Œç„¶åï¼š

1. æ£€æŸ¥`vm`çš„é€‰é¡¹å¼ api æ˜¯å¦æœ‰`render`ï¼Œæ²¡æœ‰çš„è¯è°ƒç”¨`createEmptyVNode`
2. è§¦å‘`beforeMount`é’©å­
3. å®ä¾‹åŒ–`Watcher`ï¼Œå…¶å›è°ƒå‡½æ•°è°ƒç”¨`vm._render`ç”Ÿæˆè™šæ‹Ÿ nodeï¼Œç„¶åç”¨`vm._update`æ›´æ–° DOM
4. æ ‡è®°`vm._isMounted`ï¼Œè§¦å‘`mounted`é’©å­

### render

é€šè¿‡å¯¹æŒ‚è½½è¿‡ç¨‹çš„åˆ†æå¯ä»¥çœ‹å‡ºè¾ƒä¸ºå…³é”®çš„æ˜¯`vm._render`å’Œ`vm._update`ï¼Œ
è¿™ä¸¤ä¸ªéƒ½æ˜¯å®ä¾‹ç§æœ‰æ–¹æ³•ï¼Œæ˜¯åœ¨å‡†å¤‡å·¥ä½œä¸­æåˆ°çš„`renderMixin`å’Œ`lifecycleMixin`å¯¹`Vue.prototype`æ‹“å±•çš„ï¼Œ

`Vue.prototype._render`çš„å…³é”®æ“ä½œï¼š

1. æŒ‚è½½çˆ¶èŠ‚ç‚¹åˆ°`vm.$vnode`
2. è°ƒç”¨å®ä¾‹ä¸Šçš„`render`æ–¹æ³•ï¼ˆå³`options`ä¸Šçš„ï¼Œå¯èƒ½æ˜¯ç»è¿‡`template`è½¬æ¢è€Œæ¥ï¼‰

### createElement

æºç ä¸­å¯ä»¥æ³¨æ„åˆ°åœ¨è°ƒç”¨å®ä¾‹çš„ render æ–¹æ³•æ˜¯è¿™ç§å§¿åŠ¿

```javascript
vnode = render.call(vm._renderProxy, vm.$createElement);
```

è€Œè¿™ä¸ª`vm.$createElement`æ˜¯ç”±`vm._init`->`initRender`å£°æ˜åœ¨`vm`ä¸Šçš„ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯
`src/core/vdom/create-element.js`

ç•¥å»ä¸€äº›ç»†èŠ‚ï¼ˆæœ‰ç‚¹å¤æ‚äº†ï¼Œä¸å†è¿™é‡Œå±•å¼€ï¼‰ï¼Œå®ƒåšçš„ä¸»è¦å·¥ä½œå°±æ˜¯ï¼š

1. è§„èŒƒåŒ– children
2. åˆ›å»º VNode

### update

ä»æŒ‚è½½çš„æºç å¯çŸ¥`vm._update`è°ƒç”¨çš„æ—¶æœºä¸ºé¦–æ¬¡æ¸²æŸ“å’Œæ•°æ®æ›´æ–°æ—¶ï¼Œå®ƒæ˜¯åœ¨`lifecycleMixin`ä¸­æ‹“å±•çš„ï¼Œ
å®ƒåšçš„äº‹æƒ…å°±æ˜¯ç»å…¸çš„å·®å¼‚æ¯”å¯¹`vm.__patch__`ï¼ˆå¹³å°ç›¸å…³çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æ˜¯åœ¨`platform/web/runtime/`ä¸­å®šä¹‰çš„ï¼‰ï¼Œ

`platform/web/runtime/platch.js`åˆè¡¨æ˜è¿™ä¸ªæ–¹æ³•æ˜¯`src/core/vdom/patch.js`è¿”å›çš„ï¼Œ
patch å¾ˆå¤æ‚ ğŸ˜­ğŸ˜­ï¼Œè®°ä¸€äº›å…³é”®ç‚¹ï¼š

1. æ”¯æŒçš„ nodeOps æ˜¯å› å¹³å°è€Œå¼‚çš„
2. å…³äºå­èŠ‚ç‚¹çš„å¤„ç†æ˜¯æ·±åº¦ä¼˜å…ˆçš„ï¼Œcreated é’©å­æ·±è‡ªåº•å‘ä¸Šè§¦å‘ï¼Œæ’å…¥é¡ºåºä¹Ÿæ˜¯å¦‚æ­¤

## ç»„ä»¶åŒ–

åœ¨è°ƒç”¨`createElement`çš„è¿‡ç¨‹ä¸­ï¼Œä¼šåˆ¤æ–­æ˜¯å¦ç»„ä»¶ï¼Œè°ƒç”¨`createComponent`:

1. æ„é€ å­ç±»æ„é€ å‡½æ•°ï¼ˆé€šè¿‡åŸå‹ç»§æ‰¿çš„æ–¹æ³•ï¼Œç»„ä»¶å¯¼å‡ºçš„å¯¹è±¡ç»§æ‰¿ Vue çš„ä¸€ä¸ªå­ç±»ï¼Œå¹¶ç¼“å­˜ï¼‰
2. å®‰è£…ç»„ä»¶é’©å­å‡½æ•°
3. å®ä¾‹åŒ–`vnode`

`TODO ç»„ä»¶patchçš„å·®å¼‚`

ç»„ä»¶çš„æ³¨å†Œæ–¹å¼åˆ†ä¸ºå…¨å±€æ³¨å†Œå’Œå±€éƒ¨æ³¨å†Œï¼Œå®é™…ä¸Š`globalApi`ä¸­åˆå§‹åŒ–äº†`['component','directive','filter']`
ä¸‰ä¸ªå…¨å±€å‡½æ•°

å¼‚æ­¥ç»„ä»¶æ”¯æŒï¼š

1. é€šè¿‡æ™®é€šçš„å·¥å‚å‡½æ•°
2. promise
3. é«˜çº§å¼‚æ­¥ç»„ä»¶ï¼Œé€šè¿‡ promise å®šä¹‰éœ€è¦åŠ è½½çš„ç»„ä»¶ï¼Œå¹¶å¯å®šä¹‰åŠ è½½ä¸­å’ŒåŠ è½½é”™è¯¯çš„ç»„ä»¶ï¼Œå’Œç­‰å¾…æ—¶é—´ delayã€è¶…æ—¶æ—¶é—´ timeout ç­‰ï¼Œ
   æœ¬è´¨ä¸Šæ˜¯ä¸¤æ¬¡æ¸²æŸ“ï¼ˆdelay ä¸º 0 ç¬¬ä¸€æ¬¡ç›´æ¥æ¸²æŸ“ loading ç»„ä»¶ï¼Œå¦åˆ™ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹ï¼Œå¼‚æ­¥ç»„ä»¶åè·å–æˆåŠŸåï¼Œ
   é€šè¿‡`forceRender`å¼ºåˆ¶é‡æ–°æ¸²æŸ“

## å“åº”å¼åŸç†

![vue2å“åº”å¼åŸç†](https://ustbhuangyi.github.io/vue-analysis/assets/reactive.png)

### å“åº”å¼å¯¹è±¡åˆ›å»ºè¿‡ç¨‹

è®°å½•ä¸€ä¸‹å…³é”®ç‚¹ï¼š

1. å®ä¾‹åŒ–->`vm._init`->`initState`->åˆå§‹åŒ–`props`ã€`methods`ã€`data`ã€`computed`ã€`watcher`ç­‰
2. åˆå§‹åŒ–`props`ï¼šéå†`props`
   1. è°ƒç”¨`defineReactive`æŠŠæ¯ä¸ª`prop`å¯¹åº”çš„å€¼è½¬æ¢ä¸ºå“åº”å¼ï¼Œä½¿å¾—`vm._props.xxx`èƒ½è®¿é—®åˆ°å¯¹åº”å±æ€§
   2. è°ƒç”¨`proxy`æŠŠè®¿é—®`vm._props.xxx`çš„è®¿é—®ä»£ç†åˆ°`vm.xxx`ä¸Š
3. åˆå§‹åŒ–`data`ï¼šéå†`data`å‡½æ•°è¿”å›çš„å¯¹è±¡
   1. è°ƒç”¨`proxy`æŠŠæ¯ä¸€ä¸ªå€¼`vm._data.xxx`éƒ½ä»£ç†åˆ°`vm.xxx`ä¸Š
   2. è°ƒç”¨`observe`æ–¹æ³•è§‚æµ‹æ•´ä¸ª`data`çš„å˜åŒ–ï¼Œå°†`data`å˜æˆå“åº”å¼
4. `proxy`æ–¹æ³•ï¼šé€šè¿‡`defineProperty`æŠŠ`target[[sourceKey][key]]`çš„è¯»å†™å˜æˆ`target[key]`çš„è¯»å†™ï¼Œ
   ä½¿å¾—`vm.xxx`èƒ½å¤Ÿè®¿é—®åˆ°`vm._props.xxx`å’Œ`vm._data.xxx`
5. `observe`æ–¹æ³•ï¼š
   1. ä¼ å…¥å€¼ä¸æ˜¯å¯¹è±¡æˆ–æ˜¯ä¸€ä¸ª VNode å¯¹è±¡åˆ™ return æ‰
   2. å£°æ˜ä¸€ä¸ª`Observer`
   3. æ£€æŸ¥å¯¹è±¡æ˜¯å¦æ·»åŠ äº†`Obsever`ï¼Œå¦‚æœæ·»åŠ äº†ï¼Œå–è¿™ä¸ª`Observer`
   4. æ²¡æœ‰æ·»åŠ `Observer`çš„è¯ï¼Œåœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶ä¸‹ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª`Observer`
   5. è¿”å›è¿™ä¸ª`Observer`
6. `Observer`ç±»ï¼Œç”¨æ¥ç»™å¯¹è±¡çš„å±æ€§æ·»åŠ  getter å’Œ setterï¼Œå³ä¼ è¯´ä¸­çš„**_ä¾èµ–æ”¶é›†_**å’Œ**_æ´¾å‘æ›´æ–°_**ï¼š
   1. æ„é€ å‡½æ•°å…ˆå®ä¾‹åŒ–ä¸€ä¸ª`Dep`å¯¹è±¡
   2. æ‰§è¡Œ`def`å‡½æ•°æŠŠè‡ªèº«å®ä¾‹æ·»åŠ åˆ°å…¥å‚å¯¹è±¡`value`çš„`__ob__`å±æ€§ä¸Š
   3. åˆ¤æ–­`value`æ˜¯å¦æ•°ç»„ï¼Œæ˜¯åˆ™è°ƒç”¨`observeArray`æ–¹æ³•
      1. éå†æ•°ç»„å†æ¬¡è°ƒç”¨`observe`æ–¹æ³•
   4. å¦åˆ™è°ƒç”¨`walk`æ–¹æ³•
      1. éå†`value`å¯¹è±¡çš„ key è°ƒç”¨`defineReactive`æ–¹æ³•
7. `defineReactive`çš„åŠŸèƒ½æ˜¯å®šä¹‰ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå…¥å‚æ˜¯å¯¹è±¡å’Œå±æ€§åç­‰ï¼Œç»™å¯¹è±¡åŠ¨æ€æ·»åŠ  getter å’Œ setterï¼š
   1. åˆå§‹åŒ–ä¸€ä¸ª`Dep`å¯¹è±¡å®ä¾‹ï¼Œ
   2. è·å–å…¥å‚`obj`çš„å±æ€§æè¿°ç¬¦ï¼Œå¯¹å­å¯¹è±¡åœ°æŸœè°ƒç”¨`observe`æ–¹æ³•
   3. å®šä¹‰ getter å’Œ setter

### ä¾èµ–æ”¶é›†

ä¸Šé¢çš„æåˆ°çš„`Dep`å¯¹è±¡å…¶å®å°±æ˜¯ä¾èµ–æ”¶é›†çš„æ ¸å¿ƒï¼Œå®ƒåœ¨æºç ä¸­æ˜¯ä¸ª classï¼Œç±»ä¸Šæœ‰ä¸ªå…¨å±€é™æ€å±æ€§`target`ï¼Œ
æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„`Watcher`ï¼Œ`Dep`å®é™…ä¸Šæ˜¯å¯¹`Watcher`çš„ä¸€ç§ç®¡ç†

`Watcher`ä¹Ÿæ˜¯ä¸€ä¸ª Classï¼Œè¿™ä¸ªç±»æœ‰å¾ˆå¤šå±æ€§ï¼Œå’Œ`Dep`ç›¸å…³çš„æœ‰ï¼š

```javascript
this.deps = []; // å½“å‰Watcherå®ä¾‹æŒæœ‰çš„Depå®ä¾‹æ•°ç»„
this.newDeps = []; // æ–°æ·»åŠ çš„ä¾èµ–æ•°ç»„
this.depIds = new Set();
this.newDepIds = new Set();
```

å›æƒ³ Vue çš„ mount è¿‡ç¨‹ï¼Œåœ¨è°ƒç”¨`mountComponent`å‡½æ•°æ—¶ï¼Œå®ä¾‹åŒ–äº†ä¸€ä¸ª`Watcher`ï¼Œå¤§è‡´å‘ç”Ÿäº†è¿™äº›äº‹ï¼š

1. è¿›å…¥`Watcher`æ„é€ å‡½æ•°é€»è¾‘
   1. `this.get()`
   2. `pushTarget(this)`
2. å°†`Watcher`å®ä¾‹èµ‹å€¼`Dep.target`å¹¶æ”¾å…¥æ ˆä¸­
3. è§¦å‘`Wacher`çš„ç¬¬äºŒä¸ªå…¥å‚å‡½æ•°`updateComponent`
   1. æ‰§è¡Œ`vm._update`ï¼Œè§¦å‘`vm._render()`
   2. ç”Ÿæˆ VNode çš„è¿‡ç¨‹è§¦å‘`vm`ä¸Šçš„æ•°æ®è®¿é—®
   3. è§¦å‘æ•°æ®å¯¹è±¡çš„`getter`
4. è°ƒç”¨æ•°æ®å¯¹è±¡çš„`dep.depend()`å³`Dep.target.addDep(å½“å‰depå®ä¾‹)`å³`watcher.addDep()`
   1. æŒ‰ç…§æ¡ä»¶æ›´æ–°`watcher`çš„`newDeps`å’Œ`newDepsIds`ï¼Œå¹¶æ‰§è¡Œ`dep.addSub`
   2. è°ƒç”¨`traverse`é€’å½’è®¿é—®ï¼Œè§¦å‘å­é¡¹`getter`
   3. è°ƒç”¨`popTarget`å’Œæ¸…ç©ºä¾èµ–

//TODO æ­¤å¤„åº”è¯¥æœ‰å¼ å›¾ ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­

> ä¾èµ–æ”¶é›†è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè¿™é‡Œå›é¡¾ä¸€ä¸‹è§‚å¯Ÿè€…æ¨¡å¼å’Œå‘å¸ƒè®¢é˜…æ¨¡å¼çš„åŒºåˆ«ï¼š
> è§‚å¯Ÿè€…æ¨¡å¼é€šå¸¸æ˜¯è§‚å¯Ÿè€…å’Œå‘å¸ƒè€…ç›´æ¥é€šå‘ï¼Œè€Œå‘å¸ƒè®¢é˜…æ¨¡å¼åœ¨ä¸¤è€…ä¹‹é—´å¤šäº†ä¸€ä¸ªä¸»é¢˜/æ—¶é—´é€šé“ï¼Œ
> å‘å¸ƒè€…å‘é€šé“å‘å¸ƒä¸»é¢˜æˆ–è€…äº‹ä»¶ï¼Œè®¢é˜…è€…å‘é€šé“è¿›è¡Œè®¢é˜…ï¼Œç”±é€šé“è§¦å‘äº‹ä»¶ä¸è®¢é˜…è€…é€šä¿¡ï¼Œ
> å…¶ç›®çš„æ˜¯é¿å…å‘å¸ƒè€…å’Œè®¢é˜…è€…äº§ç”Ÿä¾èµ–å…³ç³»ã€‚

### æ´¾å‘æ›´æ–°

è®°å½•ä¸‹å¤§è‡´è¿‡ç¨‹ï¼š

1. ä¿®æ”¹å“åº”æ•°æ®ï¼Œè§¦å‘ setter é€»è¾‘
   1. æ›´æ–°å€¼
   2. è°ƒç”¨`dep.notify()`
   3. éå†`subs`æ•°ç»„é‡Œçš„`watcher`å®ä¾‹
   4. è°ƒç”¨`watcher`çš„`update`æ–¹æ³•
   5. åŒºåˆ†`computed`ã€`sync`ä»¥åŠå…¶ä»–æ‰§è¡Œä¸åŒé€»è¾‘ï¼Œæ­¤æ—¶ä¼šèµ°åˆ°æœ€åçš„`queueWatcher`
2. æŠŠè¿™äº›`watcher`æ·»åŠ åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œ`nextTick`åæ‰§è¡Œ`flushSchedulerQueue`
   1. è‡ªé¡¶å‘ä¸‹æ’åˆ—`watcher`
   2. éå†`watcher`æ‰§è¡Œ`watcher.run()`
      1. `this.get()`è·å–å½“å‰å€¼ï¼Œè§¦å‘ç»„ä»¶æ¸²æŸ“`patch`è¿‡ç¨‹
      2. åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ–°æ—§å€¼ä¸ç›¸ç­‰ã€æ–°å€¼æ˜¯å¯¹è±¡ç±»å‹ã€deep æ¨¡å¼å¼€å¯ä»»ä½•ä¸€ä¸ªæ¡ä»¶
      3. æ‰§è¡Œ`watcher`å›è°ƒ
   3. æ¢å¤çŠ¶æ€ï¼Œæ¸…ç©ºé˜Ÿåˆ—

### nextTick

å›é¡¾äº‹ä»¶å¾ªç¯ï¼š

1. æ‰€æœ‰åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆ
2. ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª"ä»»åŠ¡é˜Ÿåˆ—"ã€‚åªè¦å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æœï¼Œå°±åœ¨"ä»»åŠ¡é˜Ÿåˆ—"ä¹‹ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚
3. ä¸€æ—¦"æ‰§è¡Œæ ˆ"ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–"ä»»åŠ¡é˜Ÿåˆ—"ï¼Œçœ‹çœ‹é‡Œé¢æœ‰å“ªäº›äº‹ä»¶ã€‚ä¹‹å‰é‚£äº›
   å¾€"ä»»åŠ¡é˜Ÿåˆ—"æ”¾äº‹ä»¶çš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¼šç»“æŸç­‰å¾…çŠ¶æ€ï¼Œè¿›å…¥æ‰§è¡Œæ ˆï¼Œå¼€å§‹æ‰§è¡Œã€‚
4. ä¸»çº¿ç¨‹ä¸æ–­é‡å¤ä¸Šé¢çš„ç¬¬ä¸‰æ­¥éª¤ã€‚

`src/core/util/next-tick.js`å•ç‹¬ç»´æŠ¤äº†`nextTick`ï¼Œå…³äº`timmerFunc`çš„å–å€¼éµå¾ªä»¥ä¸‹é¡ºåº

1. Promise
2. MutationObserver
3. setImmediate
4. setTimeout

### ç‰¹æ®Šæƒ…å†µ

è¿™ä¹Ÿæ˜¯ä¸€äº› vue2 çš„"ç‰¹è‰²"

1. `Object.defineProperty`å®ç°çš„å“åº”å¼å¯¹è±¡ï¼Œæ–°å¢å±æ€§æ— æ³•è§¦å‘ setterï¼Œvue ä¸ºæ­¤ä¸“é—¨æä¾›äº†`set`æ–¹æ³•
2. æ— æ³•ç›‘æµ‹æ•°ç»„çš„ç´¢å¼•æ“ä½œã€length æ“ä½œï¼Œå¹¶ä¸”é‡å†™äº†æ•°ç»„çš„ä¸€äº›æ–¹æ³•ä½¿å…¶å®ç°å“åº”å¼
   `[ 'push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse' ]`ï¼Œ
   å¹¶ä¸”è·å–äº†èƒ½å¢åŠ æ•°ç»„é•¿åº¦çš„æ–¹æ³•çš„æ’å…¥å€¼ï¼Œå°†å…¶è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡ï¼Œæœ€ååœ¨æ–¹æ³•å†…éƒ¨ä¸»åŠ¨è°ƒç”¨`ob.dep.notify()`

### è®¡ç®—å’Œä¾¦å¬

è®¡ç®—å±æ€§æœ¬è´¨ä¸Šæ˜¯ `computed watcher`ï¼Œè€Œä¾¦å¬å±æ€§æœ¬è´¨ä¸Šæ˜¯ `user watcher`ã€‚
å°±åº”ç”¨åœºæ™¯è€Œè¨€ï¼Œè®¡ç®—å±æ€§é€‚åˆç”¨åœ¨æ¨¡æ¿æ¸²æŸ“ä¸­ï¼ŒæŸä¸ªå€¼æ˜¯ä¾èµ–äº†å…¶å®ƒçš„å“åº”å¼å¯¹è±¡ç”šè‡³æ˜¯è®¡ç®—å±æ€§è®¡ç®—è€Œæ¥ï¼›
è€Œä¾¦å¬å±æ€§é€‚ç”¨äºè§‚æµ‹æŸä¸ªå€¼çš„å˜åŒ–å»å®Œæˆä¸€æ®µå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚

### ç»„ä»¶æ›´æ–°

// TODO Diff ç®—æ³•

## ç¼–è¯‘

ç®€å•è¯´å°±æ˜¯ AST è¯­æ³•æ ‘è½¬æ¢->æ ‡è®°é™æ€èŠ‚ç‚¹->å¯æ‰§è¡Œä»£ç 

![parseæµç¨‹](https://ustbhuangyi.github.io/vue-analysis/assets/parse.png)

## æ‹“å±•

è¿™ä¸€ç« èŠ‚éƒ½åªæ‹–åˆ°åé¢çœ‹äº†ä¸‹æ€»ç»“...

## Vue Router

### vue æ’ä»¶æ³¨å†ŒåŸç†

vue æä¾›äº†`Vue.use`å…¨å±€ API æ¥æ³¨å†Œæ’ä»¶ï¼Œå®ƒæ˜¯åœ¨`src/core/global-api/use.js`ä¸­ç»´æŠ¤çš„ï¼š

1. `Vue.use`æ¥å—ä¸€ä¸ª`plugin`å‚æ•°ï¼Œå¹¶åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª`_installedPlugins`æ•°ç»„
2. åˆ¤æ–­`plugin`æœ‰æ²¡æœ‰å®šä¹‰`install`æ–¹æ³•ï¼Œæœ‰çš„è¯ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶åœ¨æ‰€æœ‰å…¥å‚å‰åŠ ä¸€ä¸ª`Vue`å‚æ•°
3. æŠŠæ’ä»¶å‚¨å­˜åˆ°æ•°ç»„ä¸­

### vue-router çš„ install

å½“ç”¨æˆ·æ‰§è¡Œ`Vue.use(VueRouter)`çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯åœ¨æ‰§è¡Œ`VueRouter`çš„`install`å‡½æ•°ï¼š

1. `install`å‡½æ•°åœ¨è‡ªèº«ç»´æŠ¤äº†ä¸€ä¸ª`install.installed`æ ‡è®°æ¥ç¡®ä¿æ’ä»¶åªè¢«å®‰è£…ä¸€æ¬¡ï¼Œ
   å¹¶ç¼“å­˜äº†`Vue`å…¥å‚
2. ä½¿ç”¨`Vue.mixin`æŠŠ beforeCreate`å’Œ`destroyed`é’©å­å‡½æ•°æ³¨å…¥åˆ°æ¯ä¸€ä¸ªç»„ä»¶
3. ä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå®šä¹‰`vm.$route`å’Œ`vm.$router`
4. é€šè¿‡`Vue.component`æ–¹æ³•å®šä¹‰å…¨å±€`<router-lint>`å’Œ`<router-view>`ç»„ä»¶

### VueRouter å¯¹è±¡

`VueRouter`æ˜¯ä¸ª ES6 classï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®å±æ€§

```javascript
this.app = null; // Vueå®ä¾‹
this.apps = []; // æŒæœ‰$options.routerå±æ€§çš„Vueå®ä¾‹
this.options = options; // ä¼ å…¥çš„è·¯ç”±é…ç½®
this.beforeHooks = []; // ä¸€äº›é’©å­
this.resolveHooks = [];
this.afterHooks = [];
this.matcher = createMatcher(options.routes || [], this); // è·¯ç”±åŒ¹é…å™¨

let mode = options.mode || "hash";
// åˆ¤æ–­æ˜¯å¦å›é€€åˆ°hashæ¨¡å¼
this.fallback =
  mode === "history" && !supportsPushState && options.fallback !== false;
if (this.fallback) {
  mode = "hash";
}
if (!inBrowser) {
  mode = "abstract";
}
this.mode = mode; // è·¯ç”±æ¨¡å¼

// historyçš„ä¸åŒå®ç°åˆ†æ”¯
switch (mode) {
  case "history":
    this.history = new HTML5History(this, options.base);
    break;
  case "hash":
    this.history = new HashHistory(this, options.base, this.fallback);
    break;
  case "abstract":
    this.history = new AbstractHistory(this, options.base);
    break;
  default:
    if (process.env.NODE_ENV !== "production") {
      assert(false, `invalid mode: ${mode}`);
    }
}
```

// TODO matcher history.transitionTo

## Vuex

![vuexåŸç†](https://ustbhuangyi.github.io/vue-analysis/assets/vuex1.png)

## æœ€å

éå¸¸æµ…çš„è¿‡äº†ä¸€éå¤§ä½¬çš„ã€Švue æŠ€æœ¯æ­ç§˜ã€‹ï¼Œè¯´å®è¯æ²¡å¤ªåƒé€ï¼Œæš‚æ—¶åªåœ¨è„‘æµ·ä¸­å»ºç«‹äº† vue çš„æ€»ä½“æ¡†æ¶ï¼Œ
ä¸å¤ªå»ºè®®ä¸€ä¸Šæ¥å°±è¯»è¿™ä¸ªï¼Œè¿˜æ˜¯å¾—å…ˆå¯¹ vue æœ‰ä¸€å®šçš„ç†è§£ã€‚
